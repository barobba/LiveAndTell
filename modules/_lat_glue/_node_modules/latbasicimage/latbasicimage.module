<?php

//
// TODO: "NODE/UPLOAD/IMAGE" SHOULD BE "NODE/IMAGE/UPLOAD-IMAGE".
//

function latbasicimage_init() {
  
  //
  // CSS FOR "NODE/UPLOAD/IMAGE" MENU PATH.
  //
  
  $path = drupal_get_path('module', 'latbasicimage');
  if ($_REQUEST['q'] == 'node/upload/image') {
    drupal_add_css("$path/css/image-upload.css");
  }
}

function latbasicimage_menu() {
  
  //
  // MENU PATH FOR UPLOADING AN IMAGE (PAGE W/ SIMPLIFIED UI).
  //
  
  $items = array(
    'node/upload/image' => array(
      'file' => 'latbasicimage.pages.inc',
      'title' => 'Add pictures from computer',
      'page callback' => '_latbasicimage_page_upload',
      'page arguments' => array(1),
      'access callback' => 'node_access',
      'access arguments' => array('create', 2),
      'type' => MENU_NORMAL_ITEM,
    ),
  );
  
  return $items;
}

function latbasicimage_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  if ($node->type == 'image') {
    switch($op) {
      case 'load':
        
        
        
        //
        // SPECIAL CASE: TEMPLATED NODE ELEMENTS
        //
        // In this case, "image" nodes are part of a class of media
        // that will be displayed & positioned. So, it the node needs
        // to include these variables. This is similar to implementing
        // a java interface.
        //
        
        // Normal size URL
        $img_filepath = $node->field_image[0]['filepath'];
        $img_url = imagecache_create_url('dynamicscale_640_640', $img_filepath);
        $node->lat_media_url = $img_url;
        $node->lat_media_width = 640;
        $node->lat_media_height = 640;
        
        // Thumb size URL
        $img_thumb_url = imagecache_create_url('thumbnail_100', $img_filepath);
        $node->lat_media_thumb_url = $img_thumb_url;
        $node->lat_media_thumb_width = 100;
        $node->lat_media_thumb_height = 100;
        

        
        break;
      case 'view':
        $teaser = $a3;
        $full_page = $a4;
        $is_fullpage_node_display = $teaser == FALSE && $full_page == TRUE;
        if ($is_fullpage_node_display) {
          
          
          
          //
          // SPECIAL CASE: REDIRECTING NEW "IMAGE" NODES.
          // Only applies if a user created a node at "node/upload/image".
          //
          // After a basic "image" node has been uploaded then we want to
          // redirect the user to the page where images are attached to
          // albums. 
          //
          
          $just_finished_uploading_an_image = $_SERVER['HTTP_REFERER'] == url("node/upload/image", array('absolute' => TRUE));
          if ($just_finished_uploading_an_image) {
            drupal_goto("/user/$node->uid/notebooks/images/add-items");
          }
          
          
          
        }
        break;
      default:
        // Do nothing
        break;
    }
  }
}

function latbasicimage_preprocess_page(&$vars) {
  
  //
  // SPECIAL CASE: REMOVE VERTICAL TABS SCRIPT
  // Only applies at the menu path "node/upload/image".
  //
  // We want to hide the node options from the user when he or she is 
  // uploading an image. The Vertical Tabs script is getting in the way so we
  // are going to remove it.
  //
  
  if ($_REQUEST['q'] == 'node/upload/image') {
    lat_vars_page_script_vertical_tabs_remove($vars);
  }
   
}
