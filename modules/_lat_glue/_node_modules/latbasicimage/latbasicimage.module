<?php

function latbasicimage_init() {
  $path = drupal_get_path('module', 'latbasicimage');
  if ($_REQUEST['q'] == 'node/upload/image') {
    drupal_add_css("$path/css/image-upload.css");
  }
}

function latbasicimage_menu() {
  $items = array(
    'node/upload/image' => array(
      'file' => 'latbasicimage.pages.inc',
      'title' => 'Add pictures from computer',
      'page callback' => '_latbasicimage_page_upload',
      'page arguments' => array(1),
      'access callback' => 'node_access',
      'access arguments' => array('create', 2),
      'type' => MENU_NORMAL_ITEM,
    ),
  );
  return $items;
}

function latbasicimage_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  if ($node->type == 'image') {
    switch($op) {
      case 'load':
        //
        // Instantiate the custom node variables:
        //
        // In this case, "image" nodes are part of a class of media
        // that will be displayed & positioned. So, it the node needs
        // to include these variables. This is similar to implementing
        // a java interface.
        //
        // Variables:
        //   $node->lat_media_url    - Useful for positioning media
        //   $node->lat_media_width  - Useful for positioning media
        //   $node->lat_media_height - Useful for positioning media
        //
        
        // Normal size URL
        // $node->lat_media_url = $img_filepath;
        $img_filepath = $node->field_image[0]['filepath'];
        $img_url = imagecache_create_url('dynamicscale_640_640', $img_filepath);
//        $img_filename = lnt_strip_image_path($img_filepath);
//        $img_url = lnt_get_image_url($img_filename, 640, 640, $node->type)        
        $node->lat_media_url = $img_url;
        $node->lat_media_width = 640;
        $node->lat_media_height = 640;
        
        // Thumb size URL
        $img_thumb_url = imagecache_create_url('thumbnail_100', $img_filepath);
//        $img_thumb_url = lnt_get_image_url($img_filename, 100, 100, $node->type);
        $node->lat_media_thumb_url = $img_thumb_url;
        $node->lat_media_thumb_width = 100;
        $node->lat_media_thumb_height = 100;
        
        break;
      case 'view':
        $teaser = $a3;
        $full_page = $a4;
        if ($teaser == FALSE && $full_page == TRUE) {
          $upload_url = url("node/upload/image", array('absolute' => TRUE));
          if ($_SERVER['HTTP_REFERER'] == $upload_url) {
            drupal_goto("/user/$node->uid/notebooks/images/add-items");
          }
        }
        break;
      default:
        // Do nothing
        break;
    }
  }
}

function latbasicimage_preprocess_page(&$vars) {
  if ($_REQUEST['q'] == 'node/upload/image') {
    lat_preprocess_page_for_vertical_tabs($vars);
  } 
}
