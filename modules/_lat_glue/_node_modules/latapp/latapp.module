<?php

function latapp_init() {
  $path = drupal_get_path('module', 'latapp');
  drupal_add_css("$path/css/latapp.css");
  
  $args = arg();
  $is_direct_node_page 
    =  (count($args) == 2 && is_numeric(arg(1)))
    || (count($args) == 3 && is_numeric(arg(1)) && arg(2) == 'embed'); 
  if ($is_direct_node_page) {
    $nid = arg(1);
    $app = node_load($nid);
    if ($app->type == 'latapp') {
      // Load Data, JS, and CSS
      drupal_add_css("$path/apps/storybook/storybook.css");
      // TODO: Check "latapp" node before loading JS/CSS (from "variable_get")
      $latapp_data = latapp_prepare_data_for_app_storybook($app);
      $latapp_data = json_encode($latapp_data);
      drupal_add_js("var jsPathContainer = 'div#latapp-container';", 'inline');
      drupal_add_js("var latAppData = $latapp_data;", 'inline');
      drupal_add_js("$path/apps/storybook/storybook.js", 'module', 'header', FALSE, FALSE, FALSE);
      drupal_add_js("$path/apps/storybook/storybook-driver.js", 'module', 'header', FALSE, FALSE, FALSE);
    }
    else {
      // Type is not "latapp"
    }
  }
  else {
    // Not a direct node page
  }
}

function latapp_menu() {
  $items = array(
    'node/%node/embed' => array(
      'file' => 'latapp.pages.inc',
      'title' => 'Apps',
      'page callback' => '_latapp_page_embed',
      'page arguments' => array(1),
      'access callback' => 'lnt_node_access_and_type',
      'access arguments' => array('view', 1, 'latapp'),
      'type' => MENU_CALLBACK,
    ),
  );
  return $items;
}

function latapp_nodeapi(&$node, $op, $a2, $a3) {
  if ($node->type == 'latapp') {
    switch($op) {
      case 'view':
        $is_teaser = $a2;
        $is_page = $a3;
        if ($is_page == TRUE) {
          $referenced_node = node_load($node->field_app_target_node_ref[0]['nid']);
          drupal_set_title($referenced_node->title);
        }
        // Embed the app
        $embed_code_url = url("node/$node->nid/embed", array('absolute' => TRUE));
        $embed_code = "<iframe src='$embed_code_url' id='lat-app-storybook' width='490' height='400'></iframe>";
        $node->content[] = array(
          '#value' => $embed_code,
          '#weight' => 1,
        );
        // Display the embed code
        $node->content[] = array(
          '#value' => drupal_get_form('latapp_embedcodeform', $embed_code),
          '#weight' => 2,
        );
        break;
      default:
        break;
    }
  }
}

function latapp_embedcodeform(&$form_state, $embed_code) {
  $embed_code_form = array();
  $embed_code_form['embed_code'] = array(
    '#type' => 'textfield',
    '#title' => t('Embed code'),
    '#default_value' => $embed_code,
    '#maxlength' => 500,
    '#description' => t('Copy and paste the <em>embed code</em> into your Web pages, to share this app with others.'),
  );
  return $embed_code_form;
}

/**
 * HOOK_prepare_data_for_app_STORYBOOK
 *
 * Format:
 * $latapp_data['taggedImages'][N]['embedCode'];
 * $latapp_data['taggedImages'][N]['writing'];
 */
function latapp_prepare_data_for_app_storybook($app) {
  
  // Load notebook 
  $notebook = $app->field_app_target_node_ref[0]['nid'];
  $notebook = node_load($notebook);
  $latapp_data = array();
  
  $query = <<<EOS
    select
      n.nid as nid,
      ar.field_lnt_album_noderef_nid as latalbum_noderef,
      ir.field_lnt_image_noderef_nid as latimage_noderef,
      n.status as status
    from
      {node} n
      inner join {content_field_lnt_album_noderef} ar on ar.nid = n.nid 
      inner join {content_field_lnt_image_noderef} ir on ir.nid = n.nid 
      inner join {content_type_lnt_album_entry} entry on entry.nid = n.nid
    where
      n.type = 'lnt_album_entry'
      and ar.field_lnt_album_noderef_nid = %d
    order by
      entry.field_delta_value
EOS;
  $rset = db_query($query, $notebook->nid);
  $notebook_entries = array();
  while ($row = db_fetch_object($rset)) {
    $notebook_entries []= $row;
  }
  
  // Prepare tagged image data
  $latapp_data['taggedImages'] = array();
  foreach ($notebook_entries as $notebook_entry) {
    $tagged_image = node_load($notebook_entry->latimage_noderef);
    // Make sure album_entry is published
    if ($notebook_entry->status == 1) {
      $writing_field_info = content_fields('field_lnt_image_text_examples', 'lnt_image');
      $writing = content_view_field($writing_field_info, $tagged_image);
      $latapp_data['taggedImages'] []= array(
        'embedCode' => theme('lat_image_viewer_embed_code', $tagged_image, 219, 152),
        'writing' => $writing,
      );
    }
  }
  return $latapp_data;
}

function latapp_get_files($handler) {
  switch($handler) {
    default:
      $path = drupal_get_path('module', 'latapp');
      return array(
        'stylesheet' => url("$path/apps/storybook/storybook.css"),
        'app' => url("$path/apps/storybook/storybook.js"),
        'driver' => url("$path/apps/storybook/storybook-driver.js"),
      );
      break;
  }
}

// See THEME's page-node-embed.tpl.php
function latapp_preprocess_page(&$vars) {
  $arg_path = arg(0).'/'.arg(2);
  if ($arg_path == 'node/embed') {
    $app = $vars['node'];
    $author_link = l($app->name, "user/$app->uid", array('attributes' => array('target' => '_top')));
    $vars['latapp_embed_footer'] = "LiveAndTell App created by $author_link.";
  }
}
