<?php

function _latnb_page_notebooks($account) {
  $content = '';
  $user = $GLOBALS['user'];
//  $project_menu = array();
//  $project_menu []= l('Picture books', "user/$user->uid/notebooks/images");
//  $content .= theme('item_list', $project_menu);
  drupal_goto("user/$user->uid/notebooks/images");
  return $content;
}

function _latnb_page_notebooks_images($account) {
  $content = '';
  $content .= drupal_get_form('latnb_activityform');
  $content .= views_embed_view('image_notebooks', 'default', $account->uid);
  return $content;
}

function _latnb_page_notebooks_images_add_items($account) {
  $content = '';
  $link_web = l('Web', "user/$account->uid/notebooks/images/add"); 
  $link_computer = l('computer', "user/$account->uid/notebooks/images/add/upload");
  $link_mobile = l('mobile phone', "user/$account->uid/notebooks/images/add/mobile");
  $link_click_here = l('Click here to add pictures.', "user/$account->uid/notebooks/images/add");
  $link_add_pictures = l('added them', "user/$account->uid/notebooks/images/add");
  $link_picture_books = l('Picture books', "user/$account->uid/notebooks/images");
  $steps = array(
    t("First, add pictures from the $link_web, $link_computer, or $link_mobile. ($link_click_here)"),
    t("Then, select the pictures on the right of this page (The pictures show up after you have $link_add_pictures)."),
    t("Then, select \"attach\" next to a Picture book on the left. This will attach the pictures to a picture book."),
    t("Finally, use the $link_picture_books tab to view your work.<br/>&nbsp;")
  );
  $steps = theme('item_list', $steps);
  drupal_set_message("<p>Instructions:</p> $steps");
  $media_count = latnb_user_media_count($account);
  if ($media_count > 0) {
    $content .= drupal_get_form('latnb_addtoactivityform');
    $content .= views_embed_view('image_thumbnails', 'default', $account->uid);
  }
  else {
    // Display empty page
  }
  return $content;
}

function _latnb_page_notebooks_images_add_images($account) {
  $content = '';
  $items = array();
  $items []= l('Search the Web for pictures to use', 'node/cache/image_reference');
  $items []= l('Add (upload) pictures from computer', 'node/upload/image');
  $content .= theme('item_list', $items);
  return $content;
}

function _latnb_page_notebook_apps($notebook) {
  $account = $GLOBALS['user'];
  $content = '';
  $content .= views_embed_view('lat_apps_filtered_by_node', 'default', $notebook->nid);
  if ($notebook->uid == $account->uid) {
    $content .= drupal_get_form('latnb_appform', $notebook->nid);
  }
  return $content;
}

function _latnb_page_notebook_latimage_statustoggle($notebook, $tagged_image) {
  $tagged_image->status = 1 - $tagged_image->status;
  node_save($tagged_image);
  drupal_goto("node/$notebook->nid");
}

function _latnb_page_image_detach($notebook, $tagging_image_nid) {
  foreach ($notebook->field_latimage_ref as $index => $node) {
    if ($node['nid'] == $tagging_image_nid) {
      unset($notebook->field_latimage_ref[$index]);
      node_save($notebook);
      break;
    }
  }
  drupal_goto("node/$notebook->nid");
  return "Detatching image $tagging_image_nid from notebook $notebook->nid.";
}

function _latnb_page_image_moveup($notebook, $notebook_entry) {
  $entry_weights = _latnb_entry_weights_load($notebook);
  $previous_weight = $entry_weights[0];
  foreach ($entry_weights as $index => $weight) {
    if ($notebook_entry->nid == $weight->nid) {
      $node_previous = node_load($previous_weight->nid);
      $node_previous->field_delta[0]['value'] = $weight->delta;
      node_save($node_previous);
      $notebook_entry->field_delta[0]['value'] = $previous_weight->delta; 
      node_save($notebook_entry);
      break;
    }
    $previous_weight = $weight;
  }
  drupal_goto("node/$notebook->nid");
}

function _latnb_page_image_movedown($notebook, $notebook_entry) {
  $entry_weights = _latnb_entry_weights_load($notebook);
  foreach ($entry_weights as $index => &$weight) {
    if (isset($entry_weights[$index + 1])) {
      $next_weight = &$entry_weights[$index + 1];
    }
    else {
      break;
    }
    if ($notebook_entry->nid == $weight->nid) {
      // Perform swap
      $node_next = node_load($next_weight->nid);
      $node_next->field_delta[0]['value'] = $weight->delta;
      node_save($node_next);
      $notebook_entry->field_delta[0]['value'] = $next_weight->delta; 
      node_save($notebook_entry);
      break;
    }
  }
  drupal_goto("node/$notebook->nid");
}
