<?php

// TODO: Remove this function in favor of "services" module.
function _latnb_service_node_get($node) {
  header('Content-Type: text/plain');
  print json_encode($node);
  module_invoke_all('exit');
}


function _latnb_service_add_image_nodes() {
  
  $result_string = '';
  $results = array();
  
  // Get the images
  $images = array();
  if (array_key_exists('images', $_REQUEST) && !empty($_REQUEST['images'])) {
    $images = $_REQUEST['images'];
    $images = explode(':', $images);
  }
  else {
    $result_string .= "Images not found. Please select the images on the right. Then, select 'attach' to add the images to a Picture book.\n";
  }
  
  // Create "latimage" nodes from "image" nodes.
  $latimages = array();
  foreach ($images as $image) {
    $latimage = latimage_create('image-nid', $image);
    if ($latimage) {
      $latimages []= $latimage;
    } 
    else {
      $result_string .= "Node of type 'lnt_image' was not created.\n";
    }
  } // end foreach
  
  // Create notebook_entry nodes from "latimage" nodes.
  $notebook_entries = array();
  foreach ($latimages as $latimage) {
    $notebook_entry = latnb_entry_create($latimage);
    if ($notebook_entry) {
      $notebook_entries[] = $notebook_entry;
    }
    else {
      $result_string .= "Node of type 'lnt_album_entry' was not created.\n";
    }
  } // end foreach
  
  // Point notebook_entry nodes to notebooks.
  if(array_key_exists('notebook', $_REQUEST) && count($latimages) > 0) {
    $notebook = node_load($_REQUEST['notebook']);
    $max_weight = latnb_entry_weights_max($notebook);
    $delta = $max_weight->delta + 1;
    if ($notebook) {
      foreach ($notebook_entries as $notebook_entry) {
        $notebook_entry->field_lnt_album_noderef[0]['nid'] = $notebook->nid;
        $notebook_entry->field_delta[0]['value'] = $delta++;
        node_save($notebook_entry);
        //$result_string .= "Adding image: $latimage->nid.\n";
      }
      $result_string .= "Picture book '$notebook->nid' updated with new images.\n";
    }
    else {
      // Notebook was not loaded.
      $result_string .= "Picture book was not loaded.\n";
    }
  }
  else {
    // Parameter "notebook' missing.
    $result_string .= "(The Picture book was not updated.)\n";
  }

  // Return results
  header("Content-type: text/plain");
  print json_encode(array('result_string' => $result_string, 'results' => $results));
  module_invoke_all('exit'); 
  
}
